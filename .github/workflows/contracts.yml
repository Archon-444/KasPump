name: Smart Contracts

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network for deployment'
        required: true
        type: choice
        options:
          - bscTestnet
          - bsc
          - arbitrumSepolia
          - arbitrum
          - baseSepolia
          - base
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - verify
          - deploy-and-verify

env:
  NODE_VERSION: '20'

jobs:
  deploy-contracts:
    name: Deploy Contracts
    runs-on: ubuntu-latest
    if: contains(fromJSON('["deploy", "deploy-and-verify"]'), github.event.inputs.action)
    environment: contracts-${{ github.event.inputs.network }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Deploy contracts
        run: npx hardhat run scripts/deploy-deterministic.ts --network ${{ github.event.inputs.network }}
        env:
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          BSC_RPC_URL: ${{ secrets.BSC_RPC_URL }}
          BSC_TESTNET_RPC_URL: ${{ secrets.BSC_TESTNET_RPC_URL }}
          ARBITRUM_RPC_URL: ${{ secrets.ARBITRUM_RPC_URL }}
          ARBITRUM_SEPOLIA_RPC_URL: ${{ secrets.ARBITRUM_SEPOLIA_RPC_URL }}
          BASE_RPC_URL: ${{ secrets.BASE_RPC_URL }}
          BASE_SEPOLIA_RPC_URL: ${{ secrets.BASE_SEPOLIA_RPC_URL }}

      - name: Save deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ github.event.inputs.network }}
          path: |
            deployments/
            artifacts/
          retention-days: 30

  verify-contracts:
    name: Verify Contracts
    runs-on: ubuntu-latest
    needs: [deploy-contracts]
    if: |
      always() &&
      contains(fromJSON('["verify", "deploy-and-verify"]'), github.event.inputs.action) &&
      (needs.deploy-contracts.result == 'success' || needs.deploy-contracts.result == 'skipped')
    environment: contracts-${{ github.event.inputs.network }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        if: github.event.inputs.action == 'deploy-and-verify'
        with:
          name: deployment-${{ github.event.inputs.network }}
        continue-on-error: true

      - name: Verify contracts
        run: npx hardhat run scripts/auto-verify-with-retry.ts --network ${{ github.event.inputs.network }}
        env:
          BSCSCAN_API_KEY: ${{ secrets.BSCSCAN_API_KEY }}
          ARBISCAN_API_KEY: ${{ secrets.ARBISCAN_API_KEY }}
          BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
        continue-on-error: true

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-contracts, verify-contracts]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Contract Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy-contracts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ needs.verify-contracts.result }} |" >> $GITHUB_STEP_SUMMARY
